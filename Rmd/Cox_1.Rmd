---
title: "Cox_1"
author: "Angélique Saillet"
date: "08/03/2023"
output: html_document
---

```{r setup, include=FALSE}
library(readxl)
library(survival)
library(ggfortify)
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
source("../R/pre-treatment_db.R")
```

# Clinical only

## Statistiques descriptives 

```{r}
clinical.db$follow<-as.numeric(clinical.db$follow)
# histogramme
hist(clinical.db$follow,main='Histogramme de la durée de suivie')

#boxplot
boxplot(clinical.db$follow,main="distribution de follow")
abline(h=mean(clinical.db$follow,na.rm=T),col='red',lty=2)

#boxplot en fonction de classification 
boxplot(clinical.db$follow~clinical.db$ABC_GCB,ylab="Durée de survie",col=c(3,4),main="boxplot de follow en fonction de ABC_GCB")#Données globales(i.e données non censurées et censurées)

#taux de censure par grp
length(which(clinical.db$censor==0))/length(clinical.db$censor)#0=censored, 1=no-censored
```

## Cox général 

```{r,warning=F,message=F}
survie<-Surv(clinical.db$follow,clinical.db$censor)
fit<-survfit(survie~1)
autoplot(fit)+ylim(0,1)
```

# Clinical & RNA

## Ebauche processus à effectuer gène par gène sur BLC2 

```{r}
gene.code="BCL2"
```

```{r}
hist(as.numeric(rna.db[,which(colnames(rna.db)==gene.code)]),main=paste0("expression de ",gene.code," en log2"))
```

```{r}
cox.gene<-linearCox.analyze(gene.code)$m
rna<-as.numeric(rna.db[,which(colnames(rna.db)==gene.code)])
linearCox.analyze(gene.code)

test<-summary(cox.gene)
test$logtest[3] #likelihood ratio 
test$sctest[3] #score test / log rank
```

## Productions graphiques 

Résidus score : 

```{r}
residuals(cox.gene,type='score')
plot(predict(cox.gene),residuals(cox.gene,type='score'))
plot(clinical.db$follow,residuals(cox.gene,type='score'))

```

R2 : 

```{r}
library(CoxR2)
coxr2(cox.gene)$rsq #R2, Difference in log partial likelihoods between the fitted model and the null model with no regressors is divided by the number of uncensored events
#based on the partial likelihood ratio statistic

summary(cox.gene)$rsq[1] # R2, Difference in log partial likelihoods between the fitted model and the null model with no regressors is divided by the number of total observation (Nagelkirke)
```

Courbes roc : 

```{r}
library(survivalROC)
scr<-predict(cox.gene,type='risk')
roc.1<-survivalROC(Stime=clinical.db$follow,status=clinical.db$censor,marker=scr,predict.time=10,span=0.05)
roc.2<-survivalROC(Stime=clinical.db$follow,status=clinical.db$censor,marker=scr,predict.time=10,method="KM")

plot(roc.1$FP,roc.1$TP,type='l',col='red')
points(roc.2$FP,roc.2$TP,type='l',col='blue')
abline(a=0,b=1)

#quel marker ? 
```

Concordance : 

```{r}
conc<-concordance(cox.gene)
lower<-conc$concordance-sqrt(conc$var)*1.96
upper<-conc$concordance+sqrt(conc$var)*1.96
```


## Si linéaire PAS SATISFAISANT 

Pour avoir une idée de la fonction non paramétrique 

```{r}
#Regression smooth vis a vis de la censure si linéaire pas ok ! 
plot(rna,clinical.db$censor)
lines(smooth.spline(rna,clinical.db$censor),col='red')

#Residus martingales du modèle nul 
cox.0<-coxph(survie ~1,data=clinical.db)
plot(rna,residuals(cox.0,type="martingale"))
lines(smooth.spline(rna,residuals(cox.gene,type="martingale")),col='red')
```
